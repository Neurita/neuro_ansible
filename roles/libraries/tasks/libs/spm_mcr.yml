---

- include_tasks: matlab_runtime.yml
  tags: matlab_runtime

- set_fact:
    lib_name: 'spm12'
    pkg_url: "http://www.fil.ion.ucl.ac.uk/spm/download/restricted/utopia/dev/spm12_latest_Linux_R2017b.zip"

- set_fact:
    unarchive_dir: "{{ soft_dir }}/{{ lib_name }}"
    pkg_path: "{{ soft_dir }}/{{ lib_name }}/{{ pkg_url | basename }}"
    check_if_exists: "{{ soft_dir }}/{{ lib_name }}/run_spm12.sh"

- name: '{{ lib_name }} | Create download directory'
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - "{{ unarchive_dir }}"

- name: '{{ lib_name }} | Download package'
  get_url:
    url: "{{ pkg_url }}"
    dest: "{{ pkg_path }}"

- name: '{{ lib_name }} | Unzip package'
  command: unzip {{ pkg_path }} -d {{ unarchive_dir }}

- name: '{{ lib_name }} | Add to {{ bashrc_file }} 1/3'
  lineinfile:
    dest: "{{ bashrc_file }}"
    regexp: '^export SPM_DIR=.*'
    line: 'export SPM_DIR=${SOFT}/spm12'
    backrefs: yes

- name: '{{ lib_name }} | Add to {{ bashrc_file }} 2/3'
  lineinfile:
    dest: "{{ bashrc_file }}"
    regexp: '^export SPMMCRCMD=.*'
    line: 'export SPMMCRCMD="${SPM_DIR}/run_spm12.sh ${MCR_DIR} script"'
    backrefs: yes

- name: '{{ lib_name }} | Add to {{ bashrc_file }} 3/3'
  lineinfile:
    dest: "{{ bashrc_file }}"
    regexp: '^export FORCE_SPMMCR=1$'
    line: 'export FORCE_SPMMCR=1'
    backrefs: yes
